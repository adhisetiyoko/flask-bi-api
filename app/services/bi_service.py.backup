# app/services/bi_service.py
import requests
from requests.adapters import HTTPAdapter
from urllib3.util.retry import Retry
from datetime import datetime, timedelta
from flask import jsonify, request

BASE_URL = "https://www.bi.go.id/hargapangan/WebSite"

# -------------------------------------------------
# ğŸ”¹ FUNGSI UTAMA UNTUK HARGA PANGAN
# -------------------------------------------------
def get_harga_data(req):
    try:
        province_id = req.args.get("province_id", "")
        commodity_id = req.args.get("commodity_id", "")
        regency_id = req.args.get("regency_id", "")

        url = f"{BASE_URL}/Home/GetHarga?provinsi={province_id}&kabkota={regency_id}&komoditas={commodity_id}"
        res = requests.get(url, timeout=15)
        res.raise_for_status()
        data = res.json()

        if not data:
            return jsonify({"success": False, "message": "Data tidak ditemukan"}), 404

        latest = data[0]
        prev = data[1] if len(data) > 1 else None

        latest_price = latest.get("harga")
        latest_date = latest.get("tanggal")
        prev_price = prev.get("harga") if prev else None

        # hitung perubahan harga
        if prev_price:
            change = latest_price - prev_price
            if change > 0:
                trend = "naik"
            elif change < 0:
                trend = "turun"
            else:
                trend = "stabil"
        else:
            change = 0
            trend = "stabil"

        return jsonify({
            "success": True,
            "data": {
                "commodity": latest.get("komoditas"),
                "province": latest.get("provinsi"),
                "regency": latest.get("kabkota"),
                "latest_date": latest_date,
                "price": latest_price,
                "price_change": change,
                "trend": trend
            }
        })

    except Exception as e:
        return jsonify({"success": False, "error": str(e)}), 500


# -------------------------------------------------
# ğŸ”¹ KHUSUS KOMODITAS CABAI
# -------------------------------------------------
def get_cabai_data(req):
    try:
        province_id = req.args.get("province_id", "")
        commodity_ids = ["11", "12", "13"]  # contoh ID cabai merah besar, rawit merah, hijau
        result = []

        for cid in commodity_ids:
            url = f"{BASE_URL}/Home/GetHarga?provinsi={province_id}&komoditas={cid}"
            res = requests.get(url, timeout=15)
            res.raise_for_status()
            data = res.json()
            if not data:
                continue

            latest = data[0]
            prev = data[1] if len(data) > 1 else None

            latest_price = latest.get("harga")
            latest_date = latest.get("tanggal")
            prev_price = prev.get("harga") if prev else None

            if prev_price:
                change = latest_price - prev_price
                if change > 0:
                    trend = "naik"
                elif change < 0:
                    trend = "turun"
                else:
                    trend = "stabil"
            else:
                change = 0
                trend = "stabil"

            result.append({
                "commodity": latest.get("komoditas"),
                "latest_date": latest_date,
                "price": latest_price,
                "price_change": change,
                "trend": trend
            })

        return jsonify({"success": True, "data": result})

    except Exception as e:
        return jsonify({"success": False, "error": str(e)}), 500


# -------------------------------------------------
# ğŸ”¹ DATA MASTER
# -------------------------------------------------
def get_provinces():
    try:
        url = f"{BASE_URL}/Home/GetProvinceAll"
        r = requests.get(url, timeout=15)
        r.raise_for_status()
        return jsonify({"success": True, "data": r.json()})
    except Exception as e:
        return jsonify({"success": False, "error": str(e)}), 500


def get_commodities():
    try:
        url = f"{BASE_URL}/Home/GetCommoditiesTree"
        r = requests.get(url, timeout=15)
        r.raise_for_status()
        data = r.json()

        # Ambil hanya komoditas yang punya ParentID (bukan kategori utama)
        commodities = [
            {
                "id": item["TreeID"],
                "name": item["TreeName"]
            }
            for item in data.get("data", [])
            if item.get("ParentID") is not None
        ]

        return jsonify({"success": True, "commodities": commodities})
    except Exception as e:
        return jsonify({"success": False, "error": str(e)}), 500


def get_regencies(request):
    province_id = request.args.get("province_id")
    if not province_id:
        return jsonify({
            "success": False,
            "message": "Parameter province_id diperlukan"
        }), 400

    try:
        url = f"{BASE_URL}/Home/GetRegencyAll"
        params = {"ref_prov_id": province_id}
        r = requests.get(url, params=params, timeout=10)
        r.raise_for_status()
        return jsonify({"success": True, "data": r.json()})
    except requests.RequestException as e:
        return jsonify({"success": False, "error": str(e)}), 500


def get_price_types():
    """Ambil daftar jenis pasar (Pasar Tradisional / Modern)"""
    try:
        url = f"{BASE_URL}/Home/GetType"  # âœ… perbaikan di sini
        r = requests.get(url, timeout=15)
        r.raise_for_status()
        data = r.json()

        clean_data = [
            {
                "id": item.get("price_type_id"),
                "name": item.get("price_type_name")
            }
            for item in data.get("data", [])
        ]
        return jsonify({"success": True, "data": clean_data})
    except Exception as e:
        return jsonify({"success": False, "error": str(e)}), 500
    

# def get_latest_date():
#     """Ambil tanggal saat ini dan beberapa hari sebelumnya"""
#     try:
#         from datetime import datetime, timedelta
        
#         today = datetime.now()
        
#         # Generate 10 hari terakhir sebagai opsi
#         available_dates = []
#         for i in range(10):
#             date = today - timedelta(days=i)
#             available_dates.append(date.strftime("%d/%m/%Y"))
        
#         return jsonify({
#             "success": True,
#             "latest_date": available_dates[0],
#             "available_dates": available_dates,
#             "message": "Pilih tanggal untuk melihat data harga"
#         })
        
#     except Exception as e:
#         return jsonify({
#             "success": False,
#             "error": str(e)
#         }), 500

def create_session():
    """Buat session dengan retry mechanism"""
    session = requests.Session()
    
    retry_strategy = Retry(
        total=3,
        backoff_factor=1,
        status_forcelist=[429, 500, 502, 503, 504],
        allowed_methods=["HEAD", "GET", "OPTIONS"]
    )
    
    adapter = HTTPAdapter(max_retries=retry_strategy)
    session.mount("http://", adapter)
    session.mount("https://", adapter)
    
    return session


# def get_latest_date():
#     """Ambil tanggal dengan fallback mechanism"""
#     try:
#         from datetime import datetime, timedelta
        
#         today = datetime.now()
#         available_dates = [(today - timedelta(days=i)).strftime("%d/%m/%Y") for i in range(30)]
        
#         # Default response (fallback)
#         response_data = {
#             "success": True,
#             "latest_date": available_dates[0],
#             "available_dates": available_dates,
#             "source": "generated"
#         }
        
#         # Coba hit API BI (jika gagal tidak masalah)
#         try:
#             session = create_session()
            
#             url = f"{BASE_URL}/TabelHarga/GetGridDataDaerah"
            
#             headers = {
#                 'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
#                 'Accept': 'application/json',
#                 'Referer': 'https://www.bi.go.id/hargapangan/'
#             }
            
#             params = {
#                 "price_type_id": "1",
#                 "comcat_id": "1",
#                 "province_id": "",
#                 "regency_id": "",
#                 "market_id": "",
#                 "tipe_laporan": "1",
#                 "start_date": "",
#                 "end_date": ""
#             }
            
#             r = session.get(url, params=params, headers=headers, timeout=8)
            
#             if r.status_code == 200:
#                 data = r.json()
#                 if data.get("data"):
#                     # Extract dates from data
#                     date_keys = set()
#                     for item in data["data"][:5]:  # Ambil sample
#                         for key in item.keys():
#                             if isinstance(key, str) and "/" in key:
#                                 try:
#                                     datetime.strptime(key, "%d/%m/%Y")
#                                     date_keys.add(key)
#                                 except:
#                                     pass
                    
#                     if date_keys:
#                         sorted_dates = sorted(
#                             list(date_keys),
#                             key=lambda x: datetime.strptime(x, "%d/%m/%Y"),
#                             reverse=True
#                         )
#                         response_data = {
#                             "success": True,
#                             "latest_date": sorted_dates[0],
#                             "available_dates": sorted_dates[:5],
#                             "source": "API BI"
#                         }
        
#         except Exception as api_error:
#             # Log error tapi tetap return data default
#             print(f"API BI error (using fallback): {api_error}")
        
#         return jsonify(response_data)
        
#     except Exception as e:
#         return jsonify({
#             "success": False,
#             "error": str(e)
#         }), 500

def get_latest_date():
    """Ambil tanggal dengan fallback mechanism"""
    try:
        today = datetime.now()
        
        # Generate 30 hari terakhir (bukan 10)
        available_dates = []
        for i in range(30):
            date = today - timedelta(days=i)
            available_dates.append({
                "date": date.strftime("%d/%m/%Y"),
                "day": date.strftime("%A"),  # Nama hari
                "display": date.strftime("%d %B %Y")  # Format tampilan
            })
        
        # Default response (fallback)
        response_data = {
            "success": True,
            "latest_date": available_dates[0]["date"],
            "available_dates": available_dates,
            "source": "generated"
        }
        
        # Coba hit API BI (jika gagal tidak masalah)
        try:
            session = create_session()
            
            url = f"{BASE_URL}/TabelHarga/GetGridDataDaerah"
            
            headers = {
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
                'Accept': 'application/json',
                'Referer': 'https://www.bi.go.id/hargapangan/'
            }
            
            params = {
                "price_type_id": "1",
                "comcat_id": "1",
                "province_id": "",
                "regency_id": "",
                "market_id": "",
                "tipe_laporan": "1",
                "start_date": "",
                "end_date": ""
            }
            
            r = session.get(url, params=params, headers=headers, timeout=8)
            
            if r.status_code == 200:
                data = r.json()
                if data.get("data"):
                    # Extract dates from data
                    date_keys = set()
                    for item in data["data"][:5]:
                        for key in item.keys():
                            if isinstance(key, str) and "/" in key:
                                try:
                                    datetime.strptime(key, "%d/%m/%Y")
                                    date_keys.add(key)
                                except:
                                    pass
                    
                    if date_keys:
                        sorted_dates = sorted(
                            list(date_keys),
                            key=lambda x: datetime.strptime(x, "%d/%m/%Y"),
                            reverse=True
                        )
                        
                        # Format dengan info tambahan
                        formatted_dates = []
                        for date_str in sorted_dates[:10]:
                            dt = datetime.strptime(date_str, "%d/%m/%Y")
                            formatted_dates.append({
                                "date": date_str,
                                "day": dt.strftime("%A"),
                                "display": dt.strftime("%d %B %Y")
                            })
                        
                        response_data = {
                            "success": True,
                            "latest_date": sorted_dates[0],
                            "available_dates": formatted_dates,
                            "source": "API BI"
                        }
        
        except Exception as api_error:
            print(f"[WARNING] API BI error (using fallback dates): {api_error}")
        
        return jsonify(response_data)
        
    except Exception as e:
        return jsonify({
            "success": False,
            "error": str(e)
        }), 500

def get_price(req):
    """Ambil data harga menggunakan endpoint TabelHarga yang lebih stabil"""
    try:
        province_id = req.args.get("province_id", "")
        regency_id = req.args.get("regency_id", "")
        commodity_id = req.args.get("commodity_id")
        date = req.args.get("date")
        price_type_id = req.args.get("price_type_id", "1")

        # Validasi
        if not commodity_id:
            return jsonify({
                "success": False, 
                "message": "Parameter commodity_id wajib diisi"
            }), 400
        
        if not date:
            return jsonify({
                "success": False, 
                "message": "Parameter date wajib diisi (format: DD/MM/YYYY)"
            }), 400

        # Validasi format tanggal
        try:
            dt = datetime.strptime(date, "%d/%m/%Y")
        except ValueError:
            return jsonify({
                "success": False,
                "message": "Format tanggal tidak valid. Gunakan format DD/MM/YYYY"
            }), 400

        # âœ… GUNAKAN ENDPOINT TabelHarga
        url = f"{BASE_URL}/TabelHarga/GetGridDataDaerah"
        
        # Tentukan rentang tanggal (ambil data sekitar tanggal yang diminta)
        start_date = (dt - timedelta(days=1)).strftime("%d/%m/%Y")
        end_date = (dt + timedelta(days=1)).strftime("%d/%m/%Y")
        
        params = {
            "price_type_id": price_type_id,
            "comcat_id": "",  # Kosongkan untuk semua kategori
            "province_id": province_id,
            "regency_id": regency_id,
            "market_id": "",
            "tipe_laporan": "1",
            "start_date": start_date,
            "end_date": end_date
        }

        headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
            'Accept': 'application/json',
            'Referer': 'https://www.bi.go.id/hargapangan/'
        }

        session = create_session()
        r = session.get(url, params=params, headers=headers, timeout=15)
        r.raise_for_status()
        result = r.json()

        if not result.get("data"):
            return jsonify({
                "success": False,
                "message": "Data tidak tersedia untuk parameter yang diberikan",
                "suggestion": "Coba dengan provinsi atau tanggal lain",
                "params_sent": params
            }), 404

        # âœ… Parse data dan filter berdasarkan commodity_id dan date
        filtered_data = []
        
        for item in result["data"]:
            # Filter berdasarkan commodity_id (TreeID)
            if str(item.get("TreeID")) == str(commodity_id):
                # Cek apakah ada data harga untuk tanggal yang diminta
                price_value = item.get(date)
                
                if price_value and price_value not in [0, "", None, "-"]:
                    try:
                        price_float = float(str(price_value).replace(",", ""))
                    except:
                        continue
                    
                    filtered_data.append({
                        "market_name": item.get("nama_pasar", "N/A"),
                        "commodity": item.get("TreeName", "N/A"),
                        "price": price_float,
                        "date": date,
                        "province": item.get("provinsi", ""),
                        "regency": item.get("kabkota", ""),
                        "price_type": "Tradisional" if str(price_type_id) == "1" else "Modern",
                        "unit": "Kg"
                    })

        if not filtered_data:
            # Cari tanggal-tanggal yang tersedia dalam data
            available_dates = set()
            for item in result["data"][:10]:
                for key in item.keys():
                    if "/" in str(key):
                        available_dates.add(key)
            
            return jsonify({
                "success": False,
                "message": f"Data tidak tersedia untuk komoditas ID {commodity_id} pada tanggal {date}",
                "available_dates": sorted(list(available_dates))[:5],
                "suggestion": "Coba gunakan tanggal lain atau commodity_id yang berbeda",
                "total_records_checked": len(result["data"])
            }), 404

        # âœ… Hitung statistik
        prices = [item["price"] for item in filtered_data]
        stats = {
            "min": round(min(prices), 2) if prices else 0,
            "max": round(max(prices), 2) if prices else 0,
            "avg": round(sum(prices) / len(prices), 2) if prices else 0,
            "count": len(prices)
        }

        return jsonify({
            "success": True,
            "data": filtered_data,
            "statistics": stats,
            "metadata": {
                "date": date,
                "commodity_id": commodity_id,
                "province_id": province_id if province_id else "Semua Provinsi",
                "regency_id": regency_id if regency_id else "Semua Kabupaten/Kota",
                "price_type": "Tradisional" if str(price_type_id) == "1" else "Modern",
                "total_records": len(filtered_data)
            }
        })

    except requests.Timeout:
        return jsonify({
            "success": False,
            "error": "Request timeout - Server BI tidak merespons"
        }), 504
    
    except requests.ConnectionError:
        return jsonify({
            "success": False,
            "error": "Gagal terhubung ke server BI"
        }), 503
    
    except requests.HTTPError as e:
        return jsonify({
            "success": False,
            "error": f"HTTP Error: {e.response.status_code}",
            "url": e.response.url,
            "detail": "Endpoint API BI mungkin berubah atau parameter tidak valid"
        }), e.response.status_code
    
    except Exception as e:
        return jsonify({
            "success": False,
            "error": str(e),
            "type": type(e).__name__
        }), 500  


def debug_price(req):
    """Debug endpoint dengan raw response"""
    try:
        province_id = req.args.get("province_id", "14")
        date = req.args.get("date", "13/11/2025")
        
        try:
            dt = datetime.strptime(date, "%d/%m/%Y")
            start_date = (dt - timedelta(days=1)).strftime("%d/%m/%Y")
            end_date = (dt + timedelta(days=1)).strftime("%d/%m/%Y")
        except:
            start_date = ""
            end_date = ""
        
        url = f"{BASE_URL}/TabelHarga/GetGridDataDaerah"
        params = {
            "price_type_id": "1",
            "comcat_id": "",
            "province_id": province_id,
            "regency_id": "",
            "market_id": "",
            "tipe_laporan": "1",
            "start_date": start_date,
            "end_date": end_date
        }
        
        headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
            'Accept': 'application/json',
            'Referer': 'https://www.bi.go.id/hargapangan/'
        }
        
        r = requests.get(url, params=params, headers=headers, timeout=15)
        
        # âœ… Debug raw response
        return jsonify({
            "success": True,
            "url": r.url,
            "status_code": r.status_code,
            "content_type": r.headers.get('Content-Type'),
            "raw_text": r.text[:500],  # 500 karakter pertama
            "response_length": len(r.text),
            "params_sent": params
        })
        
    except Exception as e:
        return jsonify({
            "success": False,
            "error": str(e),
            "error_type": type(e).__name__
        }), 500
    